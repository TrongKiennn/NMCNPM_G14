CREATE OR REPLACE FUNCTION update_order_total()
RETURNS TRIGGER AS $$
BEGIN
    UPDATE orders
    SET total = (
        SELECT SUM(detail_orders.quantity * products.price)
        FROM detail_orders 
        JOIN products  ON detail_orders.product_id = products.product_id
        WHERE detail_orders.order_id = NEW.order_id
    )
    WHERE orders.order_id = NEW.order_id;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;


CREATE TRIGGER trg_update_order_total
AFTER INSERT OR UPDATE OR DELETE
ON detail_orders
FOR EACH ROW
EXECUTE FUNCTION update_order_total();


// Tự động sinh mã đơn hàng
CREATE SEQUENCE order_code_seq START 1;

CREATE OR REPLACE FUNCTION generate_order_code()
RETURNS TRIGGER AS $$
BEGIN
    NEW.order_code := 'DH' || LPAD(nextval('order_code_seq')::TEXT, 3, '0');
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_generate_order_code
BEFORE INSERT ON orders
FOR EACH ROW
EXECUTE FUNCTION generate_order_code();
