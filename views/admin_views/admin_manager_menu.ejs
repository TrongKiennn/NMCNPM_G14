<!DOCTYPE html>
<html lang="en" class="scroll-smooth font-sans">

<head>
    <link rel="shortcut icon" href="/images/Logo.png" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TASTEE Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lalezar&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.1/css/all.min.css"
        integrity="sha512-5Hs3dF2AEPkpNAR7UiOHba+lRSJNeM2ECkwxUIxC1Q/FLycGTbNapWXB4tP889k5T5Ju8fs4b1P5z/iB4nMfSQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="/css/main.css" rel="stylesheet">
</head>

<body>
    <div id="main" class="relative">
        <!-- #region Header -->
        <%- include('admin_layouts/admin_mainLayout', { content: locals.body }) %>
            <!-- #endregion Header -->
            <div class="z-[-1]  bg-repeat w-full h-screen fixed"></div>
            <div id="content" class="z-0 absolute w-full font-roboto-condensed">
                <div class="mt-[100px] flex ml-75p">
                    <div
                        class="js-add h-[50px] w-[170px] text-[25px] bg-[#D9BB1C] font-medium rounded-[20px] text-center leading-[3rem] mr-[65px] cursor-pointer hover:bg-[#D1B31B]">
                        Thêm món
                        <i class="fa-solid fa-circle-plus ml-2"></i>
                    </div>
                    <div class="js-add-category h-[50px] w-[170px] text-[25px] bg-[#984B01] font-medium rounded-[20px] text-center leading-[3rem] cursor-pointer hover:bg-[#873F01] transition-colors">
                        Thêm loại
                        <i class="fa-solid fa-layer-group ml-2"></i>
                    </div>
                </div>
                

                <div class="grid grid-cols-4 gap-10 px-[50px] py-[70px] overflow-hidden">
                    <% if (products.length===0) { %>
                        <!-- Hiển thị thông báo khi không có sản phẩm -->
                        <div class="col-span-4 text-center text-[22px] text-gray-500 font-medium">
                            Không có sản phẩm nào phù hợp với từ khóa tìm kiếm.
                        </div>
                        <% } else { %>
                            <!-- Dynamically generate menu items -->
                            <% products.forEach(item=> { %>
                                <div class="item bg-white rounded-lg shadow-xl relative group overflow-hidden"
                                    data-id="<%= item.product_id %>" data-status="<%= item.status %>"
                                    data-img="<%= item.product_url %>" data-name="<%= item.name %>"
                                    data-description="<%= item.description %>" data-price="<%= item.price %>"
                                    data-category="<%= item.category_id %>" data-discount="<%= item.discount %>"
                                    data-discount-active="<%= item.is_discount_active %>">

                                    <!-- Image -->
                                    <!-- Image with Status Badge -->
                                    <div class="image bg-gray-200 h-[150px] w-full rounded-t-lg relative">
                                        <img src="<%= item.product_url %>" alt="<%= item.name %>" class="w-full h-full object-cover transition-opacity duration-300 
                    <%= !item.status ? 'opacity-50' : '' %>"
                                            onerror="this.onerror=null; this.src='/admin/images/default-food.png';" />

                                        <!-- Status Badge -->
                                        <div class="absolute top-2 left-2 px-2 py-1 rounded-full text-xs font-medium
                    <%= item.status ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800' %>">
                                            <%= item.status ? 'Còn món' : 'Hết món' %>
                                        </div>
                                    </div>
                                    <!-- Content -->
                                    <div class="p-4 space-y-2">
                                        <h3 class="text-lg font-semibold text-gray-800">
                                            <%= item.name %>
                                        </h3>
                                        <div class="relative group/tooltip">
                                            <p class="text-sm text-gray-600 line-clamp-2 hover:line-clamp-none">
                                                <%= item.description || 'No description provided' %>
                                            </p>
                                            <div
                                                class="absolute bottom-full left-0 w-64 bg-gray-900 text-white text-sm rounded-lg p-2 hidden group-hover/tooltip:block z-10">
                                                <%= item.description || 'No description provided' %>
                                            </div>
                                        </div>
                                        <!-- Price Section -->
                                        <div class="space-y-1">
                                            <% if (item.is_discount_active && item.discount> 0) { %>
                                                <div class="flex items-center space-x-2">
                                                    <span class="text-gray-500 line-through text-sm">
                                                        <%= parseInt(item.price).toLocaleString('vi-VN') %>đ
                                                    </span>
                                                    <span class="text-red-500 font-bold">
                                                        <%= parseInt(item.price * (1 -
                                                            item.discount/100)).toLocaleString('vi-VN') %>đ
                                                    </span>
                                                </div>
                                                <% } else { %>
                                                    <div class="text-gray-800 font-bold">
                                                        <%= parseInt(item.price).toLocaleString('vi-VN') %>đ
                                                    </div>
                                                    <% } %>
                                        </div>

                                        <!-- Discount Status -->
                                        <div class="flex items-center justify-between text-sm">
                                            <span class="text-gray-600">Khuyến mãi:</span>
                                            <span class="<%= item.discount > 0 ? 'text-red-500' : 'text-gray-500' %>">
                                                <%= item.discount %>%
                                            </span>
                                        </div>

                                        <div class="flex items-center justify-between text-sm">
                                            <span class="text-gray-600">Trạng thái KM:</span>
                                            <span
                                                class="<%= item.is_discount_active ? 'text-green-500' : 'text-gray-500' %>">
                                                <%= item.is_discount_active ? 'Đang áp dụng' : 'Không áp dụng' %>
                                            </span>
                                        </div>
                                    </div>

                                    <!-- Action Buttons -->
                                    <div
                                        class="absolute inset-0 bg-black/50 flex items-center justify-center gap-4 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button
                                            class="js-edit text-white hover:text-[#D9BB1C] text-2xl transition-colors">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button
                                            class="js-delete text-white hover:text-red-500 text-2xl transition-colors">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <% }) %>
                                    <% } %>
                                        
                </div>
                <!-- pagination -->
                <div class="mt-12 mb-8 flex justify-center">
                    <div class="inline-flex rounded-md shadow-lg">
                        <% if (pagination.hasPrev) { %>
                            <a href="?page=<%= pagination.page - 1 %>"
                                class="px-6 py-3 text-lg font-medium text-gray-600 bg-white border border-gray-300 rounded-l-lg hover:bg-gray-100">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                        <% } %>
                
                        <% for(let i=1; i <=pagination.totalPages; i++) { %>
                            <a href="?page=<%= i %>"
                                class="px-6 py-3 text-lg font-medium <%= i === pagination.page ? 'text-white bg-[#D9BB1C]' : 'text-gray-600 bg-white hover:bg-gray-100' %> border border-gray-300">
                                <%= i %>
                            </a>
                        <% } %>
                
                        <% if (pagination.hasNext) { %>
                            <a href="?page=<%= pagination.page + 1 %>"
                                class="px-6 py-3 text-lg font-medium text-gray-600 bg-white border border-gray-300 rounded-r-lg hover:bg-gray-100">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        <% } %>
                    </div>
                </div>
            </div>
            
    </div>

    <!-- MODAL Xóa món -->
    <div
        class="modal-delete js-modal-delete z-[3] fixed top-0 right-0 bottom-0 left-0 bg-black/40 items-center justify-center font-roboto-condensed hidden">
        <div class="modal-container js-modal-container bg-white w-[500px] min-h-[165px] rounded-xl animate-modalFadeIn">
            <header class="modal-header text-[25px] font-bold text-center mt-5 mb-5">
                Bạn chắc chắn muốn xóa món chứ?
            </header>

            <div class="mt-9 ml-[4.5rem] mr-[4.5rem] flex justify-between">
                <button
                    class="js-modal-Yes w-[100px] bg-[#984B01] text-[18px] text-white font-bold uppercase border-none p-[1px] cursor-pointer leading-[37px] rounded-2xl hover:opacity-80">
                    Có
                </button>

                <button
                    class="js-modal-No w-[100px] bg-[#984B01] text-[18px] text-white font-bold uppercase border-none cursor-pointer p-[1px] leading-[37px] rounded-2xl hover:opacity-80">
                    Không
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL Thêm món -->
    <div
        class="modal-add js-modal-add z-[3] fixed top-0 right-0 bottom-0 left-0 bg-black/40 flex items-center justify-center font-roboto-condensed hidden">
        <div class="modal-container js-modal-container bg-white w-[900px] min-h-[165px] rounded-xl animate-modalFadeIn">
            <h2 class="text-2xl font-bold pt-4 pb-4 mb-4 text-center bg-[#984B01] rounded-t-xl text-white">Thêm Món</h2>

            <form action="/admin/create" method="POST" class="flex flex-row p-6 gap-6" enctype="multipart/form-data">

                <div id="drop-area"
                    class="w-1/2 h-45 border-dashed border-2 border-gray-400 rounded-lg p-6 text-center flex justify-center items-center flex-1 flex-col">
                    <i class="fa-solid fa-cloud-arrow-up text-3xl text-gray-600"></i>
                    <label for="file-input"
                        class="text-lg text-white cursor-pointer bg-[#984B01] rounded-md pl-3 pr-3 mt-2">
                        Chọn hình ảnh
                    </label>
                    <input class="form-control" name="product_url" type="file" id="file-input" hidden>
                    <p class="text-sm text-gray-600 mt-2">Hoặc kéo thả hình ảnh vào đây</p>
                    <div id="previewContainer"
                        class=" mt-4 border-2 border-dashed border-gray-300 rounded-lg w-full h-48 flex items-center justify-center bg-gray-50">
                        <p class='text-gray-500'>Ảnh xem trước</p>
                    </div>
                </div>

                <div class="space-y-4 flex flex-col flex-2 gap-3 w-1/2">

                    <input name="name" id="name" type="text" placeholder="Tên món"
                        class="w-full border p-2 rounded form-control" required>
                    <textarea name="description" id="description" placeholder="Mô tả"
                        class="w-full border p-2 rounded h-[100px] form-control" required></textarea>
                    <input name="price" id="price" type="number" placeholder="Giá"
                        class="w-full border p-2 rounded form-control" required>
                    <div>
                        <label for="category_id" class="block text-gray-700">Phân loại</label>
                        <select id="category_id" name="category_id" name="category_id"
                            class="form-control w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required>
                            <option disabled value="">--- Chọn phân loại ---</option>
                            <option value="1">Burger</option>
                            <option value="2">Pizza</option>
                            <option value="3">Gà rán</option>
                            <option value="4">Đồ ăn nhẹ</option>
                            <option value="5">Đồ uống</option>
                        </select>
                    </div>

                    <div class="flex items-center justify-between">
                        <button no-btn type="button"
                            class="js-modal-Cancel bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Hủy</button>
                        <button yes-btn type="submit"
                            class="js-modal-Save bg-[#984B01] text-white px-4 py-2 rounded hover:bg-[#733601]">Lưu</button>
                    </div>
                </div>
            </form>
        </div>
        <div id="toast" class="fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded hidden"></div>
    </div>

    <!-- MODAL Sửa món -->
    <div
        class="modal-edit js-modal-edit z-[3] fixed top-0 right-0 bottom-0 left-0 bg-black/40 flex items-center justify-center font-roboto-condensed hidden">
        <div class="modal-container js-modal-container bg-white w-[900px] min-h-[165px] rounded-xl animate-modalFadeIn">
            <h2 class="text-2xl font-bold pt-4 pb-4 mb-4 text-center bg-[#984B01] rounded-t-xl text-white">Chỉnh sửa món
            </h2>
            <form action="" method="POST" id="editFoodForm" class="flex flex-row p-6 gap-6"
                enctype="multipart/form-data">
                <div id="drop-area-fix"
                    class="w-1/2 h-45 border-dashed border-2 border-gray-400 rounded-lg p-6 text-center flex justify-center items-center flex-1 flex-col">
                    <i class="fa-solid fa-cloud-arrow-up text-3xl text-gray-600"></i>
                    <label for="file-input-fix"
                        class="text-lg text-white cursor-pointer bg-[#984B01] rounded-md pl-3 pr-3 mt-2">
                        Chọn hình ảnh
                    </label>
                    <input class="form-control" type="file" id="file-input-fix" hidden>
                    <p class="text-sm text-gray-600 mt-2">Hoặc kéo thả hình ảnh vào đây</p>
                    <div id="previewContainerFix"
                        class=" mt-4 border-2 border-dashed border-gray-300 rounded-lg w-full h-48 flex items-center justify-center bg-gray-50">
                        <img id="editFoodImage" src="" alt="Hình ảnh món ăn"
                            class="w-full h-full object-cover hidden" />
                        <p class='text-gray-500'>Ảnh xem trước</p>
                    </div>
                </div>

                <div class="space-y-4 flex flex-col flex-2 gap-3 w-1/2">
                    <!-- Tên món -->
                    <div>
                        <label for="editFoodName" class="block text-sm font-medium text-gray-700">Tên món ăn</label>
                        <input type="text" id="editFoodName" name="name" placeholder="Tên món"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 form-control"
                            required />
                    </div>
                    <!-- Mô tả -->
                    <div>
                        <label for="editFoodDescription" class="block text-sm font-medium text-gray-700">Mô tả</label>
                        <textarea id="editFoodDescription" name="description" placeholder="Nhập mô tả món ăn"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 form-control"
                            required></textarea>
                    </div>
                    <!-- Giá -->
                    <div>
                        <label for="editFoodPrice" class="block text-sm font-medium text-gray-700">Giá (VNĐ)</label>
                        <input type="number" id="editFoodPrice" name="price" placeholder="Nhập giá món ăn"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 form-control"
                            required />
                    </div>
                    <div>
                        <label for="editCategory_id" class="block text-sm font-medium text-gray-700">Phân loại</label>
                        <select id="editCategory_id" name="category_id"
                            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 form-control"
                            required>
                            <option disabled value="">--- Chọn phân loại ---</option>
                            <option value="1">Burger</option>
                            <option value="2">Pizza</option>
                            <option value="3">Gà rán</option>
                            <option value="4">Đồ ăn nhẹ</option>
                            <option value="5">Đồ uống</option>
                        </select>
                    </div>

                    <!-- Status Toggle -->
                    <!-- Add before discount section in edit form -->
                    <div class="space-y-4 p-4 bg-gray-50 rounded-lg">
                        <div class="flex items-center justify-between">
                            <label class="block text-sm font-medium text-gray-700">Trạng thái món</label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="editStatus" name="status" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 rounded-full peer 
                        peer-focus:ring-4 peer-focus:ring-[#984B01]/50 
                        peer-checked:after:translate-x-full peer-checked:after:border-white 
                        after:content-[''] after:absolute after:top-0.5 after:left-[2px] 
                        after:bg-white after:border-gray-300 after:border after:rounded-full 
                        after:h-5 after:w-5 after:transition-all peer-checked:bg-[#984B01]">
                                </div>
                                <span class="ml-3 text-sm font-medium text-gray-700" id="statusText"></span>
                            </label>
                        </div>
                    </div>
                    <!-- Discount Section -->
                    <div class="space-y-4 p-4 bg-gray-50 rounded-lg">
                        <div class="flex items-center justify-between">
                            <label class="block text-sm font-medium text-gray-700">Khuyến mãi</label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="editDiscountActive" class="sr-only peer"
                                    name="is_discount_active">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 
                           peer-focus:ring-[#984B01]/50 rounded-full peer 
                           peer-checked:after:translate-x-full peer-checked:after:border-white 
                           after:content-[''] after:absolute after:top-[2px] after:left-[2px] 
                           after:bg-white after:border-gray-300 after:border after:rounded-full 
                           after:h-5 after:w-5 after:transition-all peer-checked:bg-[#984B01]">
                                </div>
                                <span class="ml-3 text-sm font-medium text-gray-700">Áp dụng</span>
                            </label>
                        </div>

                        <div id="discountInputGroup" class="transition-all duration-300">
                            <label for="editDiscount" class="block text-sm font-medium text-gray-700 mb-1">
                                Giảm giá (%)
                            </label>
                            <div class="relative">
                                <input type="number" id="editDiscount" name="discount" min="0" max="100" class="block w-full px-3 py-2 border border-gray-300 rounded-md 
                              focus:ring-[#984B01] focus:border-[#984B01] 
                              disabled:bg-gray-100 disabled:text-gray-500" placeholder="Nhập % giảm giá">
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500">%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <button type="button"
                            class="js-modal-edit-Cancel bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Hủy</button>
                        <button type="submit"
                            class="js-modal-edit-Save bg-[#984B01] text-white px-4 py-2 rounded hover:bg-[#733601]">Lưu</button>
                    </div>
                </div>
            </form>
        </div>
        <div id="toast" class="fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded hidden"></div>
    </div>

    <!-- Thông báo showToast -->
    <script>
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white`;
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }
    </script>

    <!-- Xóa item -->
    <script>
        const Deletes = document.querySelectorAll('.js-delete')
        const modalDelete = document.querySelector('.js-modal-delete')
        const modalNo = document.querySelector('.js-modal-No')
        const modalYes = document.querySelector('.js-modal-Yes')

        let currentItemToDelete = null; // Biến lưu trữ item đang được chọn để xóa

        function showConfirmDelete() {
            modalDelete.classList.add('flex')
            modalDelete.classList.remove('hidden')
            currentItemToDelete = event.target.closest('.item') // Lưu trữ item cha của nút "Xóa"
        }

        function hideConfirmDelete() {
            modalDelete.classList.remove('flex')
            modalDelete.classList.add('hidden')
            currentItemToDelete = null
        }

        async function deleteItem() {
            if (currentItemToDelete) {
                const itemId = currentItemToDelete.dataset.id; // Lấy ID của item từ thuộc tính data-id
                if (!itemId) {
                    console.error('Không tìm thấy ID của item để xóa');
                    showToast('Không thể xác định món cần xóa!');
                    hideConfirmDelete();
                    return;
                }
                try {
                    // Gửi yêu cầu DELETE tới backend
                    const response = await fetch(`/admin/products/delete`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ id: itemId }), // Gửi ID của item tới backend
                    });

                    if (response.ok) {
                        // Nếu thành công, xóa item khỏi DOM
                        currentItemToDelete.remove();
                        hideConfirmDelete();
                        showToast('Xóa món thành công!');
                        // Redirect after successful deletion
                        window.location.href = result.redirectUrl;
                    } else {
                        showToast('Có lỗi xảy ra khi xóa món!');
                    }
                } catch (error) {
                    console.error('Lỗi khi gửi yêu cầu xóa:', error);
                    showToast('Không thể xóa món, vui lòng thử lại sau!');
                }
            }
        }

        for (const Delete of Deletes) {
            Delete.addEventListener('click', showConfirmDelete)
        }

        modalNo.addEventListener('click', hideConfirmDelete)
        modalYes.addEventListener('click', deleteItem)
    </script>

    <!-- Thêm items -->
    <script>
        const Add = document.querySelector('.js-add')
        const modalAdd = document.querySelector('.js-modal-add')
        const modalCancel = document.querySelector('.js-modal-Cancel')
        const modalSave = document.querySelector('.js-modal-Save')
        const fileInput = document.getElementById('file-input')
        const previewContainer = document.getElementById('previewContainer')
        const dropArea = document.getElementById('drop-area')
        const categorySelect = document.getElementById('category_id')

        Add.addEventListener("click", () => {
            modalAdd.classList.remove("hidden");
        });

        modalCancel.addEventListener("click", () => {
            modalAdd.classList.add("hidden");
            resetForm();
        });

        fileInput.addEventListener("change", function () {
            const file = fileInput.files[0]; // Lấy file được chọn

            if (file) {
                if (!file.type.startsWith("image/")) {
                    showToast("Vui lòng chọn file ảnh!");
                    return;
                }

                const reader = new FileReader();

                // Khi file đã được đọc xong
                reader.onload = function (e) {
                    // Tạo và hiển thị thẻ img
                    const img = document.createElement("img");
                    img.src = e.target.result;
                    img.className = "max-w-full max-h-full object-contain"; // Tailwind: hiển thị vừa vặn khung

                    // Xóa nội dung cũ và thêm ảnh mới
                    previewContainer.innerHTML = "";
                    previewContainer.appendChild(img);
                };

                reader.readAsDataURL(file); // Đọc file dưới dạng Data URL
            } else {
                // Nếu không chọn file, hiển thị lại văn bản mặc định
                previewContainer.innerHTML = "<p class='text-gray-500'>Ảnh xem trước</p>";
            }
        });

        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.classList.add('dragging'); // Thêm hiệu ứng kéo
        });

        dropArea.addEventListener('dragenter', () => {
            dropArea.classList.add('dragging');
        });

        dropArea.addEventListener('dragleave', () => {
            dropArea.classList.remove('dragging');
        });

        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('dragging');

            // Lấy file từ sự kiện drop
            const file = e.dataTransfer.files[0];

            if (file) {
                if (!file.type.startsWith("image/")) {
                    showToast("Vui lòng kéo thả file ảnh hợp lệ!");
                    return;
                }

                const reader = new FileReader();

                // Khi file đã được đọc xong
                reader.onload = function (e) {
                    const img = document.createElement("img");
                    img.src = e.target.result;
                    img.className = "max-w-full max-h-full object-contain"; // Tailwind: ảnh vừa khung

                    // Xóa nội dung cũ và hiển thị ảnh mới
                    previewContainer.innerHTML = "";
                    previewContainer.appendChild(img);
                };

                reader.readAsDataURL(file); // Đọc file dưới dạng Data URL
            } else {
                previewContainer.innerHTML = "<p class='text-gray-500'>Ảnh xem trước</p>";
            }
        });

        modalSave.addEventListener("click", (e) => {
            e.preventDefault();  // Ngăn form gửi thông qua submit mặc định
            const form = document.querySelector("form");
            if (form.checkValidity()) {
                const data = {
                    name: document.getElementById("name").value,
                    description: document.getElementById("description").value,
                    price: document.getElementById("price").value,
                    category_id: document.getElementById("category_id").value,
                    // Chuyển đổi file ảnh thành base64 nếu cần
                    product_url: fileInput.files[0] ? fileInput.files[0] : null,
                };
                saveDish(event, data);  // Gọi hàm saveDish để gửi dữ liệu
            } else {
                e.preventDefault(); // Ngăn form gửi nếu thông tin không hợp lệ
                showToast("Vui lòng nhập thông tin hợp lệ", "error");
                return;
            }
        });

        // Reset modal sau khi thêm món
        function resetForm() {
            document.getElementById("name").value = "";
            document.getElementById("description").value = "";
            document.getElementById("price").value = "";
            previewContainer.innerHTML = "<p class='text-gray-500'>Ảnh xem trước</p>";
        }


        async function saveDish(event, data) {
            try {
                // Tạo một đối tượng FormData để gửi file nếu có
                const formData = new FormData();
                formData.append("name", data.name);
                formData.append("description", data.description);
                formData.append("price", data.price);
                formData.append("category_id", data.category_id);
                if (data.product_url) {
                    formData.append("product_url", data.product_url);  // Thêm file nếu có
                }

                const response = await fetch('/admin/create', {
                    method: 'POST',
                    body: formData,
                });
                const result = await response.json();
                if (result.ok) {
                    showToast("Món ăn đã được lưu!", "success");
                    resetForm();
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showToast("Không thể tạo món", "error");
                }
            } catch (error) {
                showToast(error.message, "error");
            }
        }
    </script>

    <!-- Sửa items -->
    <script>
        const Edit = document.querySelectorAll('.js-edit')
        const editModal = document.querySelector('.modal-edit')
        const modalEditCancel = document.querySelector('.js-modal-edit-Cancel')
        const modalEditSave = document.querySelector('.js-modal-edit-Save')
        const editFoodForm = document.getElementById('editFoodForm')
        const dropAreaFix = document.getElementById('drop-area-fix')
        const fileInputFix = document.getElementById('file-input-fix');
        // Store original values
        let originalValues = {};

        // Lấy thông tin điền vào modal
        Edit.forEach((button) => {
            button.addEventListener('click', (e) => {
                const item = e.target.closest('.item');

                // Lấy dữ liệu từ thuộc tính `data-*` của hàng
                const productId = item.getAttribute('data-id');
                const status = item.getAttribute('data-status') === 'true';
                const foodImg = item.getAttribute('data-img');
                const foodName = item.getAttribute('data-name');
                const foodDescription = item.getAttribute('data-description');
                const foodPrice = item.getAttribute('data-price');
                const foodCategoryId = item.getAttribute('data-category');
                const discount = item.getAttribute('data-discount');
                const isDiscountActive = item.getAttribute('data-discount-active');

                // Set initial status
                document.getElementById('editStatus').checked = status;
                document.getElementById('statusText').textContent = status ? 'Còn món' : 'Hết món';

                // store original values
                originalValues = {
                    product_id: productId,
                    product_url: foodImg,
                    name: foodName,
                    description: foodDescription,
                    price: foodPrice,
                    category_id: foodCategoryId,
                    discount: discount,
                    is_discount_active: isDiscountActive
                };

                // Hiển thị hình ảnh trong modal
                const foodImage = document.getElementById('editFoodImage');
                if (foodImg) {
                    foodImage.src = foodImg; // Gán URL ảnh
                    foodImage.classList.remove('hidden'); // Hiển thị ảnh
                    previewContainerFix.innerHTML = "";
                    previewContainerFix.appendChild(foodImage); // Gắn ảnh vào container
                } else {
                    foodImage.classList.add('hidden'); // Ẩn ảnh nếu không có URL
                    previewContainerFix.innerHTML = "<p class='text-gray-500'>Ảnh xem trước</p>";
                }

                // Điền dữ liệu vào form trong modal
                document.getElementById('editFoodName').value = foodName;
                document.getElementById('editFoodDescription').value = foodDescription;
                document.getElementById('editFoodPrice').value = foodPrice;
                document.getElementById('editCategory_id').value = foodCategoryId;
                document.getElementById('editDiscount').value = discount;
                document.getElementById('editDiscountActive').checked = isDiscountActive;

                // Lưu productId để sử dụng khi gửi request
                window.currentEditingFood = { product_id: productId }; // Lưu ID vào biến toàn cục

                // Hiển thị modal
                editModal.classList.remove('hidden');
            });
        });


        // Lắng nghe sự kiện "Hủy" để đóng modal
        modalEditCancel.addEventListener('click', () => {
            editModal.classList.add('hidden');
        });

        // Khi nhấn Lưu gửi BE
        editFoodForm.addEventListener('submit', (e) => {
            e.preventDefault(); // Ngăn reload trang

            const formData = new FormData();
            formData.append('product_id', originalValues.product_id);
            formData.append('name', document.getElementById('editFoodName').value);
            formData.append('description', document.getElementById('editFoodDescription').value);
            formData.append('price', parseInt(document.getElementById('editFoodPrice').value, 10));
            formData.append('category_id', parseInt(document.getElementById('editCategory_id').value, 10));
            formData.append('status', document.getElementById('editStatus').checked);

            // Handle discount
            const isDiscountActive = document.getElementById('editDiscountActive').checked;
            const discountValue = isDiscountActive ?
                parseFloat(document.getElementById('editDiscount').value) : 0.00;

            formData.append('is_discount_active', isDiscountActive);
            formData.append('discount', discountValue.toFixed(2)); // Ensure 2 decimal places
            // Kiểm tra nếu người dùng đã chọn ảnh mới
            const foodImage = document.getElementById('file-input-fix').files[0];
            if (foodImage) {
                formData.append('product_url', foodImage); // Thêm ảnh vào FormData
                formData.append('isNewImage', 'true');
            }
            else {
                formData.append('product_url', originalValues.product_url); // Giữ nguyên ảnh cũ nếu không chọn ảnh mới
                formData.append('isNewImage', 'false'); // Gửi cờ để backend biết không cần update ảnh
            }



            // Gửi yêu cầu PUT đến API để cập nhật món ăn
            fetch('http://localhost:4000/admin/products/update', {
                method: 'PATCH',
                body: formData
            })
                .then(response => {
                    if (response.ok) {
                        showToast('Cập nhật món ăn thành công!');
                        editModal.classList.add('hidden');
                        window.location.reload();
                    } else {
                        showToast('Có lỗi xảy ra khi cập nhật món ăn.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Có lỗi xảy ra khi kết nối đến server.');
                });
        });

        // Xử lý kéo thả file ảnh
        fileInputFix.addEventListener("change", function () {
            const file = fileInputFix.files[0]; // Lấy file được chọn

            if (file) {
                const reader = new FileReader();

                // Khi file đã được đọc xong
                reader.onload = function (e) {
                    // Tạo và hiển thị thẻ img
                    const img = document.createElement("img");
                    img.src = e.target.result;
                    img.className = "max-w-full max-h-full object-contain"; // Tailwind: hiển thị vừa vặn khung

                    // Xóa nội dung cũ và thêm ảnh mới
                    previewContainerFix.innerHTML = "";
                    previewContainerFix.appendChild(img);
                };

                reader.readAsDataURL(file); // Đọc file dưới dạng Data URL
            } else {
                // Nếu không chọn file, hiển thị lại văn bản mặc định
                previewContainerFix.innerHTML = "<p class='text-gray-500'>Ảnh xem trước</p>";
            }
        });

        dropAreaFix.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropAreaFix.classList.add('dragging'); // Thêm hiệu ứng kéo
        });

        dropAreaFix.addEventListener('dragenter', () => {
            dropAreaFix.classList.add('dragging');
        });

        dropAreaFix.addEventListener('dragleave', () => {
            dropAreaFix.classList.remove('dragging');
        });

        dropAreaFix.addEventListener('drop', (e) => {
            e.preventDefault();
            dropAreaFix.classList.remove('dragging');

            // Lấy file từ sự kiện drop
            const file = e.dataTransfer.files[0];

            if (file) {
                if (!file.type.startsWith("image/")) {
                    showToast("Vui lòng kéo thả file ảnh hợp lệ!");
                    return;
                }

                const reader = new FileReader();

                // Khi file đã được đọc xong
                reader.onload = function (e) {
                    const img = document.createElement("img");
                    img.src = e.target.result;
                    img.className = "max-w-full max-h-full object-contain"; // Tailwind: ảnh vừa khung

                    // Xóa nội dung cũ và hiển thị ảnh mới
                    previewContainerFix.innerHTML = "";
                    previewContainerFix.appendChild(img);
                };

                reader.readAsDataURL(file); // Đọc file dưới dạng Data URL
            } else {
                previewContainerFix.innerHTML = "<p class='text-gray-500'>Ảnh xem trước</p>";
            }
        });

        // Handle discount toggle
        document.getElementById('editDiscountActive').addEventListener('change', function () {
            const discountInput = document.getElementById('editDiscount');
            discountInput.disabled = !this.checked;
            if (!this.checked) {
                discountInput.value = '0';
            }
        });

    </script>

    <!-- Cập nhật trạng thái product -->
    <script>
        document.querySelectorAll('.js-toggle-status').forEach(button => {
            button.addEventListener('click', async function () {
                // Lấy thông tin sản phẩm từ thuộc tính data
                const parent = this.closest('.item');
                const productId = parent.getAttribute('data-id');
                //const isCurrentlyAvailable = this.textContent.trim() === 'Hết món';
                const currentStatus = parent.querySelector("[status]");

                console.log(currentStatus);
                const isCurrentlyAvailable = currentStatus.getAttribute("status");
                console.log("current status: ", isCurrentlyAvailable);
                console.log("Product id: ", productId);


                try {
                    // Gửi yêu cầu cập nhật trạng thái lên server
                    const response = await fetch('/admin/products/change-status', {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ id: productId, status: isCurrentlyAvailable }) // Đổi trạng thái
                    })

                    const data = await response.json();
                    if (data.ok) {
                        // Cập nhật giao diện
                        /*if (data.status) {
                            // Nếu trước đó là "Còn món", đổi thành "Hết món"
                            parent.querySelector('.text-green-500').classList.remove('text-green-500');
                            parent.querySelector('.text-green-500').classList.add('text-red-500');
                            parent.querySelector('.text-red-500').textContent = 'Hết món';
                            this.textContent = 'Còn món'; // Đổi nút trong detail menu
    
                        } else {
                            // Nếu trước đó là "Hết món", đổi thành "Còn món"
                            parent.querySelector('.text-red-500').classList.remove('text-red-500');
                            parent.querySelector('.text-red-500').classList.add('text-green-500');
                            parent.querySelector('.text-green-500').textContent = 'Còn món';
                            this.textContent = 'Hết món'; // Đổi nút trong detail menu
                        }*/
                        showToast("Trạng thái đã được cập nhật thành công!", "success");
                        window.location.reload();
                    } else {
                        showToast("Có lỗi xảy ra khi cập nhật trạng thái.", "success");
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showToast("Có lỗi xảy ra khi gửi yêu cầu.", "error");
                }
            });
        });
    </script>
    <script src="/admin/js/script.js"></script>
</body>

</html>